<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PR 监控</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Noto+Sans+SC:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/material.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
</head>

<body>
    <div class="container">
        <h1 class="mb-4">PR 监控</h1>
        
        <!-- 添加PR表单 -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">快速添加 PR</h5>
                <form id="add-pr-form" class="row g-3">
                    <div class="col-md-9">
                        <input type="url" class="form-control" id="pr_url" name="pr_url"
                            placeholder="输入 PR 链接，如：https://gitee.com/owner/repo/pulls/1234 或 https://github.com/owner/repo/pull/1234">
                    </div>
                    <div class="col-md-3">
                    <button type="submit" class="btn btn-success w-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle me-1" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </svg>
                        添加 PR
                    </button>
                </div>
                </form>
                <div class="form-text mt-2">支持格式：https://gitee.com/{owner}/{repo}/pulls/{pr_id} 或 https://github.com/{owner}/{repo}/pull/{pr_id}</div>
            </div>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <a href="{{ url_for('config_page') }}" class="btn btn-primary me-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear me-1" viewBox="0 0 16 16">
                        <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                        <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
                    </svg>
                    修改配置
                </a>
                <a href="/automation" class="btn btn-info me-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-robot me-1" viewBox="0 0 16 16">
                        <path d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5ZM3 8.062C3 6.76 4.235 5.765 5.53 5.886a26.58 26.58 0 0 0 4.94 0C11.765 5.765 13 6.76 13 8.062v1.157a.933.933 0 0 1-.765.935c-.845.147-2.34.346-4.235.346-1.895 0-3.39-.2-4.235-.346A.933.933 0 0 1 3 9.219V8.062Zm4.542-.827a.25.25 0 0 0-.217.068l-.92.9a24.767 24.767 0 0 1-1.871-.183.25.25 0 0 0-.068.495c.55.076 1.232.149 2.02.193a.25.25 0 0 0 .189-.071l.754-.736.847 1.71a.25.25 0 0 0 .404.062l.932-.97a25.286 25.286 0 0 0 1.922-.188.25.25 0 0 0-.068-.495c-.538.074-1.207.145-1.98.189a.25.25 0 0 0-.166.076l-.754.785-.842-1.70a.25.25 0 0 0-.182-.135Z"/>
                        <path d="M8.5 1.866a1 1 0 1 0-1 0V3h-2A4.5 4.5 0 0 0 1 7.5V8a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1v1a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-1a1 1 0 0 0 1-1V9a1 1 0 0 0-1-1v-.5A4.5 4.5 0 0 0 10.5 3h-2V1.866ZM14 7.5V13a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V7.5A3.5 3.5 0 0 1 5.5 4h5A3.5 3.5 0 0 1 14 7.5Z"/>
                    </svg>
                    自动化规则
                </a>
            </div>
            <div>
                <button id="refresh-all" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise me-1" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                    </svg>
                    刷新所有数据
                </button>
            </div>
        </div>
        
        <!-- 监控PR列表 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">监控中的 PR</h5>
                <!-- 加载状态指示器 -->
                <div id="loading-indicator" class="d-none mt-2">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <span id="loading-text">加载中...</span>
                    </div>
                    <div class="progress mt-2" style="width: 200px; height: 6px;">
                        <div id="loading-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th scope="col" class="platform-col">平台</th>
                                <th scope="col" class="repo-col">仓库</th>
                                <th scope="col" class="pr-number-col">PR#</th>
                                <th scope="col" class="pr-title-col">PR 标题</th>
                                <th scope="col" class="pr-author-col">作者</th>
                                <th scope="col" class="pr-branch-col">分支</th>
                                <th scope="col" class="pr-status-col">状态</th>
                                <th scope="col" class="pr-labels-col">标签</th>
                                <th scope="col" class="pr-actions-col">操作</th>
                            </tr>
                        </thead>
                        <tbody id="pr-table-body">
                            <!-- PR数据将通过流式加载动态填充 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量操作工具栏 -->
    <div id="batch-toolbar" class="batch-toolbar d-none">
        <div class="selected-count">
            已选择 <span id="selected-count">0</span> 个 PR
        </div>
        <button class="btn btn-outline-primary btn-sm" id="select-all-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-all me-1" viewBox="0 0 16 16">
                <path d="M8.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L2.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093L8.95 4.992a.252.252 0 0 1 .02-.022zm-.92 5.14.92.92a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 1 0-1.091-1.028L9.477 9.417l-.485-.486-.943 1.179z"/>
            </svg>
            全选
        </button>
        <button class="btn btn-outline-secondary btn-sm" id="clear-selection-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-square me-1" viewBox="0 0 16 16">
                <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
            </svg>
            清除选择
        </button>
        <div class="vr"></div>
        <button class="btn btn-danger btn-sm" id="batch-delete-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash me-1" viewBox="0 0 16 16">
                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
            </svg>
            批量删除
        </button>
        <button class="btn btn-success btn-sm" id="batch-refresh-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise me-1" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
            </svg>
            批量刷新
        </button>
    </div>

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        // 多选功能相关变量
        let selectedRows = new Set();
        
        // 多选功能相关函数
        function toggleRowSelection(row, event) {
            // 阻止事件冒泡到删除按钮等其他元素
            if (event.target.closest('.delete-pr-btn') || event.target.closest('a')) {
                return;
            }
            
            const rowId = getRowId(row);
            
            if (selectedRows.has(rowId)) {
                // 取消选中
                selectedRows.delete(rowId);
                row.classList.remove('selected');
            } else {
                // 选中
                selectedRows.add(rowId);
                row.classList.add('selected');
            }
            
            updateBatchToolbar();
        }
        
        function getRowId(row) {
            const platform = row.getAttribute('data-platform') || 'gitee';
            const owner = row.getAttribute('data-owner');
            const repo = row.getAttribute('data-repo');
            const prId = row.getAttribute('data-pr-id');
            return `${platform}:${owner}/${repo}#${prId}`;
        }
        
        function updateBatchToolbar() {
            const toolbar = document.getElementById('batch-toolbar');
            const countElement = document.getElementById('selected-count');
            const selectAllBtn = document.getElementById('select-all-btn');
            
            countElement.textContent = selectedRows.size;
            
            if (selectedRows.size > 0) {
                toolbar.classList.remove('d-none');
                toolbar.classList.add('show');
                toolbar.classList.remove('hide');
            } else {
                toolbar.classList.add('hide');
                toolbar.classList.remove('show');
                setTimeout(() => {
                    if (selectedRows.size === 0) {
                        toolbar.classList.add('d-none');
                    }
                }, 300);
            }
            
            // 更新全选按钮状态
            const totalRows = document.querySelectorAll('#pr-table-body tr').length;
            if (selectedRows.size === totalRows && totalRows > 0) {
                selectAllBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-square me-1" viewBox="0 0 16 16">
                        <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                        <path d="M10.97 4.97a.75.75 0 0 1 1.071 1.05l-3.992 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093L10.97 4.97z"/>
                    </svg>
                    取消全选`;
            } else {
                selectAllBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-all me-1" viewBox="0 0 16 16">
                        <path d="M8.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L2.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093L8.95 4.992a.252.252 0 0 1 .02-.022zm-.92 5.14.92.92a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 1 0-1.091-1.028L9.477 9.417l-.485-.486-.943 1.179z"/>
                    </svg>
                    全选`;
            }
        }
        
        function selectAllRows() {
            const rows = document.querySelectorAll('#pr-table-body tr');
            const totalRows = rows.length;
            
            if (selectedRows.size === totalRows && totalRows > 0) {
                // 当前是全选状态，执行取消全选
                clearSelection();
            } else {
                // 执行全选
                rows.forEach(row => {
                    const rowId = getRowId(row);
                    selectedRows.add(rowId);
                    row.classList.add('selected');
                });
                updateBatchToolbar();
            }
        }
        
        function clearSelection() {
            const rows = document.querySelectorAll('#pr-table-body tr.selected');
            rows.forEach(row => {
                row.classList.remove('selected');
            });
            selectedRows.clear();
            updateBatchToolbar();
        }
        
        // 批量操作函数
        async function batchDeletePRs() {
            if (selectedRows.size === 0) {
                showMessage('请先选择要删除的PR', 'warning');
                return;
            }
            
            if (!confirm(`确定要删除选中的 ${selectedRows.size} 个PR吗？`)) {
                return;
            }
            
            const selectedArray = Array.from(selectedRows);
            let successCount = 0;
            let failCount = 0;
            
            showMessage(`开始批量删除 ${selectedArray.length} 个PR...`, 'info');
            
            for (const rowId of selectedArray) {
                try {
                    const [platform, rest] = rowId.split(':');
                    const [repo, prId] = rest.split('#');
                    const [owner, repoName] = repo.split('/');
                    
                    const response = await fetch('/api/delete_pr', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            platform: platform,
                            owner: owner,
                            repo: repoName,
                            pr_id: parseInt(prId)
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // 从DOM中移除该行
                        const row = document.querySelector(`tr[data-platform="${platform}"][data-owner="${owner}"][data-repo="${repoName}"][data-pr-id="${prId}"]`);
                        if (row) {
                            row.remove();
                        }
                        selectedRows.delete(rowId);
                        successCount++;
                    } else {
                        failCount++;
                        console.error(`删除PR ${rowId} 失败:`, result.error);
                    }
                } catch (error) {
                    failCount++;
                    console.error(`删除PR ${rowId} 时发生错误:`, error);
                }
            }
            
            updateBatchToolbar();
            
            if (failCount === 0) {
                showMessage(`成功删除 ${successCount} 个PR`, 'success');
            } else {
                showMessage(`删除完成：成功 ${successCount} 个，失败 ${failCount} 个`, 'warning');
            }
        }
        
        async function batchRefreshPRs() {
            if (selectedRows.size === 0) {
                showMessage('请先选择要刷新的PR', 'warning');
                return;
            }
            
            showMessage(`开始批量刷新 ${selectedRows.size} 个PR...`, 'info');
            
            // 标记选中的行为正在更新状态
            selectedRows.forEach(rowId => {
                const [platform, rest] = rowId.split(':');
                const [repo, prId] = rest.split('#');
                const [owner, repoName] = repo.split('/');
                
                const row = document.querySelector(`tr[data-platform="${platform}"][data-owner="${owner}"][data-repo="${repoName}"][data-pr-id="${prId}"]`);
                if (row) {
                    row.classList.add('updating');
                    const firstCell = row.querySelector('td:first-child');
                    if (firstCell && !firstCell.querySelector('.updating-icon')) {
                        const updateIcon = document.createElement('span');
                        updateIcon.className = 'updating-icon text-muted me-1';
                        updateIcon.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">刷新中...</span></div>';
                        firstCell.insertBefore(updateIcon, firstCell.firstChild);
                    }
                }
            });
            
            // 触发整体刷新，但只刷新选中的PR
            refreshAllData();
            showMessage('批量刷新已开始', 'success');
        }

        // 应用标签文字颜色
        function applyLabelColors() {
            document.querySelectorAll('.label-text').forEach(label => {
                const color = label.dataset.color;
                if (color) {
                    label.style.color = '#' + color;
                }
            });
        }

        // 创建带颜色的标签HTML
        function createLabelHTML(labels) {
            if (!labels || !Array.isArray(labels) || labels.length === 0) {
                return '';
            }
            return labels.map(label => {
                const color = label.color || '000000';
                return `<span class="label-text me-2" style="color: #${color}; font-weight: bold;">${label.name}</span>`;
            }).join('');
        }
        
        // 格式化日期时间函数（保留以备将来使用）
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '-';
            const date = new Date(dateTimeStr);
            if (isNaN(date.getTime())) return dateTimeStr;
            
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 显示消息提示
        function showMessage(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container');
            const existingAlert = container.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            container.insertBefore(alertDiv, container.firstElementChild.nextSibling);
            
            // 5秒后自动消失
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // 动态添加PR到表格
        function addPRToTable(prData, targetTbody) {
            const tbody = targetTbody || document.getElementById('pr-table-body');
            const row = document.createElement('tr');
            row.setAttribute('data-platform', prData.platform || 'gitee');
            row.setAttribute('data-owner', prData.owner);
            row.setAttribute('data-repo', prData.repo);
            row.setAttribute('data-pr-id', prData.pr_id);
            
            // 平台列
            const platformCell = document.createElement('td');
            platformCell.className = 'platform-col';
            const platform = prData.platform || 'gitee';
            if (platform === 'github') {
                platformCell.innerHTML = `
                    <span class="badge bg-dark">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-github me-1" viewBox="0 0 16 16">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                        </svg>
                        GitHub
                    </span>
                `;
            } else {
                platformCell.innerHTML = `
                    <span class="badge bg-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-git me-1" viewBox="0 0 16 16">
                            <path d="M15.698 7.287 8.712.302a1.03 1.03 0 0 0-1.457 0l-1.45 1.45 1.84 1.84a1.223 1.223 0 0 1 1.55 1.56l1.773 1.774a1.224 1.224 0 0 1 1.267 2.025 1.226 1.226 0 0 1-2.002-1.334L8.58 5.963v4.353a1.226 1.226 0 1 1-1.008-.036V5.887a1.226 1.226 0 0 1-.666-1.608L5.093 2.465l-4.79 4.79a1.03 1.03 0 0 0 0 1.457l6.986 6.986a1.03 1.03 0 0 0 1.457 0l6.953-6.953a1.031 1.031 0 0 0 0-1.457"/>
                        </svg>
                        Gitee
                    </span>
                `;
            }
            
            // 仓库列
            const repoCell = document.createElement('td');
            repoCell.className = 'repo-col';
            if (prData.pr_details && prData.pr_details.base && prData.pr_details.base.repo && prData.pr_details.base.repo.html_url) {
                repoCell.innerHTML = `<a href="${prData.pr_details.base.repo.html_url}" target="_blank">${prData.owner}/${prData.repo}</a>`;
            } else {
                repoCell.textContent = `${prData.owner}/${prData.repo}`;
            }
            
            // PR编号列
            const prIdCell = document.createElement('td');
            prIdCell.className = 'pr-number-col';
            if (prData.pr_details && prData.pr_details.html_url) {
                prIdCell.innerHTML = `<a href="${prData.pr_details.html_url}" target="_blank">#${prData.pr_id}</a>`;
            } else {
                prIdCell.textContent = `#${prData.pr_id}`;
            }
            
            // PR名称列
            const titleCell = document.createElement('td');
            titleCell.className = 'pr-title-col';
            if (prData.pr_details && prData.pr_details.title) {
                if (prData.pr_details.html_url) {
                    titleCell.innerHTML = `<a href="${prData.pr_details.html_url}" target="_blank" title="${prData.pr_details.title}">${prData.pr_details.title}</a>`;
                } else {
                    titleCell.textContent = prData.pr_details.title;
                }
            } else {
                titleCell.textContent = '-';
            }
            
            // 提交人列
            const authorCell = document.createElement('td');
            authorCell.className = 'pr-author-col';
            if (prData.pr_details && prData.pr_details.user) {
                const userName = prData.pr_details.user.name || prData.pr_details.user.login;
                if (prData.pr_details.user.html_url) {
                    authorCell.innerHTML = `<a href="${prData.pr_details.user.html_url}" target="_blank">${userName}</a>`;
                } else {
                    authorCell.textContent = userName;
                }
            } else {
                authorCell.textContent = '-';
            }
            
            // 分支列
            const branchCell = document.createElement('td');
            branchCell.className = 'pr-branch-col';
            if (prData.pr_details && prData.pr_details.base && prData.pr_details.base.ref) {
                const branchName = prData.pr_details.base.ref;
                if (prData.pr_details.base.repo && prData.pr_details.base.repo.html_url) {
                    branchCell.innerHTML = `<a href="${prData.pr_details.base.repo.html_url}/tree/${branchName}" target="_blank">${branchName}</a>`;
                } else {
                    branchCell.textContent = branchName;
                }
            } else {
                branchCell.textContent = '-';
            }
            
            // 状态列
            const statusCell = document.createElement('td');
            statusCell.className = 'pr-status-col';
            if (prData.pr_details && prData.pr_details.state) {
                const state = prData.pr_details.state;
                let badgeClass = 'bg-warning';
                let displayText = state.charAt(0).toUpperCase() + state.slice(1);
                
                if (state === 'open') {
                    badgeClass = 'bg-success';
                    displayText = 'Open';
                } else if (state === 'closed') {
                    badgeClass = 'bg-danger';
                    displayText = 'Closed';
                } else if (state === 'merged') {
                    badgeClass = 'bg-secondary';
                    displayText = 'Merged';
                }
                
                statusCell.innerHTML = `<span class="badge ${badgeClass}">${displayText}</span>`;
            } else {
                statusCell.innerHTML = `<span class="badge bg-light text-dark">-</span>`;
            }
            
            // 标签列
            const labelsCell = document.createElement('td');
            labelsCell.className = 'labels pr-labels-col';
            
            // 从pr_details中获取labels，而不是依赖current_labels
            let labels = [];
            if (prData.pr_details && prData.pr_details.labels && Array.isArray(prData.pr_details.labels)) {
                labels = prData.pr_details.labels;
            }
            labelsCell.innerHTML = createLabelHTML(labels);
            
            // 操作列
            const actionCell = document.createElement('td');
            actionCell.className = 'pr-actions pr-actions-col';
            actionCell.innerHTML = `<button class="btn btn-danger btn-sm delete-pr-btn" 
                    data-platform="${prData.platform || 'gitee'}"
                    data-owner="${prData.owner}" 
                    data-repo="${prData.repo}" 
                    data-pr-id="${prData.pr_id}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                    </svg>
                </button>`;
            
            row.appendChild(platformCell);
            row.appendChild(repoCell);
            row.appendChild(prIdCell);
            row.appendChild(titleCell);
            row.appendChild(authorCell);
            row.appendChild(branchCell);
            row.appendChild(statusCell);
            row.appendChild(labelsCell);
            row.appendChild(actionCell);
            tbody.appendChild(row);
        }

        // 标记所有行为"正在更新"状态
        function markAllRowsAsUpdating() {
            const tableBody = document.querySelector('#pr-table-body');
            const rows = tableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                // 添加正在更新的样式类
                row.classList.add('updating');
                
                // 在第一列添加刷新图标
                const firstCell = row.querySelector('td:first-child');
                if (firstCell && !firstCell.querySelector('.updating-icon')) {
                    const updateIcon = document.createElement('span');
                    updateIcon.className = 'updating-icon text-muted me-1';
                    updateIcon.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">更新中...</span></div>';
                    firstCell.insertBefore(updateIcon, firstCell.firstChild);
                }
            });
        }

        // 根据缓存键查找对应的表格行
        function findRowByCacheKey(cacheKey) {
            const tableBody = document.querySelector('#pr-table-body');
            const rows = tableBody.querySelectorAll('tr');
            
            for (const row of rows) {
                const platform = row.getAttribute('data-platform') || 'gitee';
                const owner = row.getAttribute('data-owner');
                const repo = row.getAttribute('data-repo');
                const prId = row.getAttribute('data-pr-id');
                
                if (owner && repo && prId) {
                    const rowCacheKey = `${platform}:${owner}/${repo}#${prId}`;
                    if (rowCacheKey === cacheKey) {
                        return row;
                    }
                }
            }
            return null;
        }

        // 更新或添加PR到表格
        function updateOrAddPRToTable(prData) {
            const cacheKey = prData.cache_key;
            const existingRow = findRowByCacheKey(cacheKey);
            
            if (existingRow) {
                // 更新现有行
                updateExistingRow(existingRow, prData);
            } else {
                // 添加新行
                addPRToTable(prData);
            }
        }

        // 更新现有行的数据
        function updateExistingRow(row, prData) {
            const tbody = document.querySelector('#pr-table-body');
            
            // 保存选中状态
            const wasSelected = row.classList.contains('selected');
            
            // 移除更新状态
            row.classList.remove('updating');
            const updateIcon = row.querySelector('.updating-icon');
            if (updateIcon) {
                updateIcon.remove();
            }
            
            // 创建新行来替换旧行
            const tempContainer = document.createElement('div');
            tempContainer.innerHTML = '<table><tbody></tbody></table>';
            const tempTbody = tempContainer.querySelector('tbody');
            
            // 使用现有的addPRToTable逻辑创建新行
            addPRToTable(prData, tempTbody);
            const newRow = tempTbody.firstChild;
            
            // 复制新行的内容到现有行
            if (newRow) {
                row.innerHTML = newRow.innerHTML;
                // 复制属性
                ['data-platform', 'data-owner', 'data-repo', 'data-pr-id'].forEach(attr => {
                    if (newRow.hasAttribute(attr)) {
                        row.setAttribute(attr, newRow.getAttribute(attr));
                    }
                });
                
                // 恢复选中状态
                if (wasSelected) {
                    row.classList.add('selected');
                }
            }
        }

        // 更新或添加错误行
        function updateOrAddErrorRow(errorData) {
            const cacheKey = `${errorData.platform || 'gitee'}:${errorData.owner}/${errorData.repo}#${errorData.pr_id}`;
            const existingRow = findRowByCacheKey(cacheKey);
            
            if (existingRow) {
                // 更新现有行为错误状态
                existingRow.classList.remove('updating');
                existingRow.classList.add('table-warning');
                
                // 移除更新图标
                const updateIcon = existingRow.querySelector('.updating-icon');
                if (updateIcon) {
                    updateIcon.remove();
                }
                
                // 更新行内容为错误信息
                existingRow.innerHTML = `
                    <td>${errorData.platform || 'gitee'}</td>
                    <td>${errorData.owner}/${errorData.repo}</td>
                    <td>#${errorData.pr_id}</td>
                    <td colspan="5" class="text-danger">加载失败: ${errorData.error}</td>
                    <td>
                        <button class="btn btn-danger btn-sm delete-pr-btn" 
                                data-platform="${errorData.platform || 'gitee'}"
                                data-owner="${errorData.owner}" 
                                data-repo="${errorData.repo}" 
                                data-pr-id="${errorData.pr_id}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                            </svg>
                        </button>
                    </td>
                `;
            } else {
                // 添加新的错误行
                const tableBody = document.querySelector('#pr-table-body');
                const row = document.createElement('tr');
                row.className = 'table-warning';
                row.setAttribute('data-platform', errorData.platform || 'gitee');
                row.setAttribute('data-owner', errorData.owner);
                row.setAttribute('data-repo', errorData.repo);
                row.setAttribute('data-pr-id', errorData.pr_id);
                row.innerHTML = `
                    <td>${errorData.platform || 'gitee'}</td>
                    <td>${errorData.owner}/${errorData.repo}</td>
                    <td>#${errorData.pr_id}</td>
                    <td colspan="5" class="text-danger">加载失败: ${errorData.error}</td>
                    <td>
                        <button class="btn btn-danger btn-sm delete-pr-btn" 
                                data-platform="${errorData.platform || 'gitee'}"
                                data-owner="${errorData.owner}" 
                                data-repo="${errorData.repo}" 
                                data-pr-id="${errorData.pr_id}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                            </svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            }
        }

        // 移除所有标记为"正在更新"但没有收到新数据的行（表示这些PR已经不在监控列表中了）
        function removeOutdatedRows() {
            const tableBody = document.querySelector('#pr-table-body');
            const updatingRows = tableBody.querySelectorAll('tr.updating');
            
            updatingRows.forEach(row => {
                row.remove();
            });
        }

        // 流式更新监控中的PR标签（使用SSE实时加载）
        function updatePRLabelsStream() {
            const loadingIndicator = document.getElementById('loading-indicator');
            const loadingText = document.getElementById('loading-text');
            const loadingProgress = document.getElementById('loading-progress');
            const tableBody = document.querySelector('#pr-table-body');
            
            // 显示加载指示器
            loadingIndicator.classList.remove('d-none');
            loadingText.textContent = '正在启动刷新...';
            loadingProgress.style.width = '0%';
            
            // 标记所有现有行为"正在更新"状态
            markAllRowsAsUpdating();
            
            // 创建EventSource连接
            const eventSource = new EventSource('/api/pr_labels_stream');
            
            eventSource.onopen = function() {
                console.log('连接已建立');
                loadingText.textContent = '连接建立，准备加载...';
            };
            
            eventSource.addEventListener('start', function(event) {
                const data = JSON.parse(event.data);
                loadingText.textContent = `正在刷新 ${data.total} 个PR的数据...`;
            });
            
            eventSource.addEventListener('pr_data', function(event) {
                const prData = JSON.parse(event.data);
                updateOrAddPRToTable(prData);
            });
            
            eventSource.addEventListener('pr_error', function(event) {
                const errorData = JSON.parse(event.data);
                console.error(`加载PR数据失败 ${errorData.cache_key}:`, errorData.error);
                updateOrAddErrorRow(errorData);
            });
            
            eventSource.addEventListener('progress', function(event) {
                const progressData = JSON.parse(event.data);
                loadingProgress.style.width = `${progressData.percentage}%`;
                loadingText.textContent = `正在加载... ${progressData.processed}/${progressData.total} (${progressData.percentage}%)`;
            });
            
            eventSource.addEventListener('complete', function(event) {
                const data = JSON.parse(event.data);
                
                // 移除所有仍在"正在更新"状态的行
                removeOutdatedRows();
                
                loadingIndicator.classList.add('d-none');
                eventSource.close();
                
                const message = data.elapsed ? 
                    `PR数据刷新完成 (耗时: ${data.elapsed}s)` : 
                    'PR数据刷新完成';
                
                console.log(message);
                showMessage(message, 'success');
                
                // 应用标签颜色
                applyLabelColors();
            });
            
            eventSource.addEventListener('error', function(event) {
                const data = JSON.parse(event.data);
                console.error('连接错误:', data.error);
                loadingIndicator.classList.add('d-none');
                eventSource.close();
                showMessage('加载失败，请稍后重试', 'danger');
            });
            
            eventSource.onerror = function(event) {
                console.error('连接错误:', event);
                loadingIndicator.classList.add('d-none');
                eventSource.close();
                showMessage('连接服务失败，请稍后重试', 'danger');
            };
        }

        // 刷新所有数据（使用高性能流式加载）
        function refreshAllData() {
            // 使用优化的流式API
            if (typeof EventSource !== 'undefined') {
                updatePRLabelsStream(); // 高性能版本
            } else {
                // 浏览器不支持SSE，显示错误信息
                showMessage('您的浏览器不支持实时更新功能，请升级浏览器', 'warning');
            }
        }

        // 处理删除PR事件
        async function handleDeletePR(event) {
            const deleteBtn = event.currentTarget;
            const platform = deleteBtn.getAttribute('data-platform') || 'gitee';  // 从按钮获取平台信息，默认为gitee
            const owner = deleteBtn.getAttribute('data-owner');
            const repo = deleteBtn.getAttribute('data-repo');
            const prId = deleteBtn.getAttribute('data-pr-id');
            
            if (confirm(`确定要删除监控 ${platform.toUpperCase()}/${owner}/${repo} 的 PR #${prId} 吗？`)) {
                try {
                    const response = await fetch('/api/delete_pr', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            platform: platform,
                            owner: owner, 
                            repo: repo, 
                            pr_id: prId 
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showMessage(result.message, 'success');
                        // 从DOM中移除该行
                        const row = deleteBtn.closest('tr');
                        if (row) {
                            row.remove();
                        }
                    } else {
                        showMessage(result.error, 'danger');
                    }
                } catch (error) {
                    showMessage('删除PR时发生错误：' + error.message, 'danger');
                }
            }
        }

        // 处理添加PR表单提交
        async function handleAddPRForm(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const prUrl = formData.get('pr_url');
            
            if (!prUrl) {
                showMessage('请输入PR URL', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/add_pr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ pr_url: prUrl })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    // 清空表单
                    event.target.reset();
                    // 添加新PR到表格
                    if (result.pr_data) {
                        addPRToTable(result.pr_data);
                    }
                } else {
                    showMessage(result.error, 'danger');
                }
            } catch (error) {
                showMessage('添加PR时发生错误：' + error.message, 'danger');
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 添加PR表单提交事件
            const addPrForm = document.getElementById('add-pr-form');
            if (addPrForm) {
                addPrForm.addEventListener('submit', handleAddPRForm);
            }

            // 表格行点击事件（多选功能）
            document.addEventListener('click', function(e) {
                const row = e.target.closest('#pr-table-body tr');
                if (row) {
                    // 检查是否点击的是删除按钮或链接
                    const deleteBtn = e.target.closest('.delete-pr-btn');
                    const link = e.target.closest('a');
                    
                    if (!deleteBtn && !link) {
                        toggleRowSelection(row, e);
                    }
                }
            });

            // 删除PR按钮点击事件（使用事件委托）
            document.addEventListener('click', function(e) {
                const deleteBtn = e.target.closest('.delete-pr-btn');
                if (deleteBtn) {
                    e.preventDefault();
                    e.stopPropagation(); // 阻止冒泡到行点击事件
                    // 创建一个模拟事件对象，currentTarget指向删除按钮
                    const mockEvent = { currentTarget: deleteBtn };
                    handleDeletePR(mockEvent);
                }
            });

            // 刷新按钮事件
            const refreshAllBtn = document.getElementById('refresh-all');
            if (refreshAllBtn) {
                refreshAllBtn.addEventListener('click', refreshAllData);
            }

            // 批量操作按钮事件
            const selectAllBtn = document.getElementById('select-all-btn');
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', selectAllRows);
            }

            const clearSelectionBtn = document.getElementById('clear-selection-btn');
            if (clearSelectionBtn) {
                clearSelectionBtn.addEventListener('click', clearSelection);
            }

            const batchDeleteBtn = document.getElementById('batch-delete-btn');
            if (batchDeleteBtn) {
                batchDeleteBtn.addEventListener('click', batchDeletePRs);
            }

            const batchRefreshBtn = document.getElementById('batch-refresh-btn');
            if (batchRefreshBtn) {
                batchRefreshBtn.addEventListener('click', batchRefreshPRs);
            }
        }

        // 定时刷新
        setInterval(refreshAllData, 60000); // 每分钟刷新监控PR
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            // 初始加载PR数据
            refreshAllData();
        });
    </script>
</body>

</html>
