<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PR 监控</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/material.css') }}" rel="stylesheet">
</head>

<body>
    <div class="container">
        <h1 class="mb-4">PR 监控</h1>
        
        <!-- 添加PR表单 -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">快速添加 PR</h5>
                <form id="add-pr-form" class="row g-3">
                    <div class="col-md-9">
                        <input type="url" class="form-control" id="pr_url" name="pr_url"
                            placeholder="输入 PR 链接，如：https://gitee.com/owner/repo/pulls/1234">
                    </div>
                    <div class="col-md-3">
                    <button type="submit" class="btn btn-success w-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle me-1" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </svg>
                        添加 PR
                    </button>
                </div>
                </form>
                <div class="form-text mt-2">支持格式：https://gitee.com/{owner}/{repo}/pulls/{pr_id}</div>
            </div>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <a href="{{ url_for('config_page') }}" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear me-1" viewBox="0 0 16 16">
                    <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                    <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
                </svg>
                修改配置
            </a>
            <div>
                <button id="refresh-all" class="btn btn-outline-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise me-1" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                    </svg>
                    刷新所有数据
                </button>
            </div>
        </div>
        
        <!-- 监控PR列表 -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th scope="col" class="repo-name">仓库</th>
                                <th scope="col" class="pr-number">PR 编号</th>
                                <th scope="col" class="pr-name">PR 名称</th>
                                <th scope="col" class="pr-author">提交人</th>
                                <th scope="col" class="pr-branch">分支</th>
                                <th scope="col" class="pr-status">状态</th>
                                <th scope="col" class="pr-labels">当前标签</th>
                                <th scope="col" class="pr-actions">操作</th>
                            </tr>
                        </thead>
                        <tbody id="pr-table-body">
                            {% for cache_key, pr_info in pr_data.items() %}
                            <tr data-owner="{{ pr_info.owner }}" data-repo="{{ pr_info.repo }}" data-pr-id="{{ pr_info.pr_id }}">
                                <td class="repo-name">
                                    {% if pr_info.pr_details and pr_info.pr_details.base and pr_info.pr_details.base.repo and pr_info.pr_details.base.repo.html_url %}
                                        <a href="{{ pr_info.pr_details.base.repo.html_url }}" target="_blank">{{ pr_info.owner }}/{{ pr_info.repo }}</a>
                                    {% else %}
                                        {{ pr_info.owner }}/{{ pr_info.repo }}
                                    {% endif %}
                                </td>
                                <td class="pr-number">
                                    {% if pr_info.pr_details and pr_info.pr_details.html_url %}
                                        <a href="{{ pr_info.pr_details.html_url }}" target="_blank">#{{ pr_info.pr_id }}</a>
                                    {% else %}
                                        #{{ pr_info.pr_id }}
                                    {% endif %}
                                </td>
                                <td class="pr-name">
                                    {% if pr_info.pr_details and pr_info.pr_details.title %}
                                        {% if pr_info.pr_details.html_url %}
                                            <a href="{{ pr_info.pr_details.html_url }}" target="_blank" title="{{ pr_info.pr_details.title }}">
                                                {{ pr_info.pr_details.title }}
                                            </a>
                                        {% else %}
                                            {{ pr_info.pr_details.title }}
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="pr-author">
                                    {% if pr_info.pr_details and pr_info.pr_details.user %}
                                        {% if pr_info.pr_details.user.html_url %}
                                            <a href="{{ pr_info.pr_details.user.html_url }}" target="_blank">
                                                {{ pr_info.pr_details.user.name or pr_info.pr_details.user.login }}
                                            </a>
                                        {% else %}
                                            {{ pr_info.pr_details.user.name or pr_info.pr_details.user.login }}
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="pr-branch">
                                    {% if pr_info.pr_details and pr_info.pr_details.base and pr_info.pr_details.base.ref %}
                                        {% if pr_info.pr_details.base.repo and pr_info.pr_details.base.repo.html_url %}
                                            <a href="{{ pr_info.pr_details.base.repo.html_url }}/tree/{{ pr_info.pr_details.base.ref }}" target="_blank">
                                                {{ pr_info.pr_details.base.ref }}
                                            </a>
                                        {% else %}
                                            {{ pr_info.pr_details.base.ref }}
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="pr-status">
                                    {% if pr_info.pr_details and pr_info.pr_details.state %}
                                        {% if pr_info.pr_details.state == 'open' %}
                                            <span class="badge bg-success">Open</span>
                                        {% elif pr_info.pr_details.state == 'closed' %}
                                            <span class="badge bg-danger">Closed</span>
                                        {% elif pr_info.pr_details.state == 'merged' %}
                                            <span class="badge bg-secondary">Merged</span>
                                        {% else %}
                                            <span class="badge bg-warning">{{ pr_info.pr_details.state|title }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-light text-dark">-</span>
                                    {% endif %}
                                </td>
                                <td class="pr-labels">
                                    {% for label in pr_info.current_labels %}
                                    <span class="label-text me-2" data-color="{{ label.color }}" style="font-weight: bold;">{{ label.name }}</span>
                                    {% endfor %}
                                </td>
                                <td>
                                    <button class="btn btn-danger btn-sm delete-pr-btn" 
                                            data-owner="{{ pr_info.owner }}" 
                                            data-repo="{{ pr_info.repo }}" 
                                            data-pr-id="{{ pr_info.pr_id }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
    </div>
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        // 应用标签文字颜色
        function applyLabelColors() {
            document.querySelectorAll('.label-text').forEach(label => {
                const color = label.dataset.color;
                if (color) {
                    label.style.color = '#' + color;
                }
            });
        }

        // 创建带颜色的标签HTML
        function createLabelHTML(labels) {
            if (!labels || !Array.isArray(labels) || labels.length === 0) {
                return '';
            }
            return labels.map(label => {
                const color = label.color || '000000';
                return `<span class="label-text me-2" style="color: #${color}; font-weight: bold;">${label.name}</span>`;
            }).join('');
        }
        
        // 格式化日期时间函数（保留以备将来使用）
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '-';
            const date = new Date(dateTimeStr);
            if (isNaN(date.getTime())) return dateTimeStr;
            
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // 显示消息提示
        function showMessage(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container');
            const existingAlert = container.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            container.insertBefore(alertDiv, container.firstElementChild.nextSibling);
            
            // 5秒后自动消失
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // 动态添加PR到表格
        function addPRToTable(prData) {
            const tbody = document.getElementById('pr-table-body');
            const row = document.createElement('tr');
            row.setAttribute('data-owner', prData.owner);
            row.setAttribute('data-repo', prData.repo);
            row.setAttribute('data-pr-id', prData.pr_id);
            
            // 仓库列
            const repoCell = document.createElement('td');
            if (prData.pr_details && prData.pr_details.base && prData.pr_details.base.repo && prData.pr_details.base.repo.html_url) {
                repoCell.innerHTML = `<a href="${prData.pr_details.base.repo.html_url}" target="_blank">${prData.owner}/${prData.repo}</a>`;
            } else {
                repoCell.textContent = `${prData.owner}/${prData.repo}`;
            }
            
            // PR编号列
            const prIdCell = document.createElement('td');
            if (prData.pr_details && prData.pr_details.html_url) {
                prIdCell.innerHTML = `<a href="${prData.pr_details.html_url}" target="_blank">#${prData.pr_id}</a>`;
            } else {
                prIdCell.textContent = `#${prData.pr_id}`;
            }
            
            // PR名称列
            const titleCell = document.createElement('td');
            if (prData.pr_details && prData.pr_details.title) {
                if (prData.pr_details.html_url) {
                    titleCell.innerHTML = `<a href="${prData.pr_details.html_url}" target="_blank" title="${prData.pr_details.title}">${prData.pr_details.title}</a>`;
                } else {
                    titleCell.textContent = prData.pr_details.title;
                }
            } else {
                titleCell.textContent = '-';
            }
            
            // 提交人列
            const authorCell = document.createElement('td');
            if (prData.pr_details && prData.pr_details.user) {
                const userName = prData.pr_details.user.name || prData.pr_details.user.login;
                if (prData.pr_details.user.html_url) {
                    authorCell.innerHTML = `<a href="${prData.pr_details.user.html_url}" target="_blank">${userName}</a>`;
                } else {
                    authorCell.textContent = userName;
                }
            } else {
                authorCell.textContent = '-';
            }
            
            // 分支列
            const branchCell = document.createElement('td');
            if (prData.pr_details && prData.pr_details.base && prData.pr_details.base.ref) {
                const branchName = prData.pr_details.base.ref;
                if (prData.pr_details.base.repo && prData.pr_details.base.repo.html_url) {
                    branchCell.innerHTML = `<a href="${prData.pr_details.base.repo.html_url}/tree/${branchName}" target="_blank">${branchName}</a>`;
                } else {
                    branchCell.textContent = branchName;
                }
            } else {
                branchCell.textContent = '-';
            }
            
            // 状态列
            const statusCell = document.createElement('td');
            if (prData.pr_details && prData.pr_details.state) {
                const state = prData.pr_details.state;
                let badgeClass = 'bg-warning';
                let displayText = state.charAt(0).toUpperCase() + state.slice(1);
                
                if (state === 'open') {
                    badgeClass = 'bg-success';
                    displayText = 'Open';
                } else if (state === 'closed') {
                    badgeClass = 'bg-danger';
                    displayText = 'Closed';
                } else if (state === 'merged') {
                    badgeClass = 'bg-secondary';
                    displayText = 'Merged';
                }
                
                statusCell.innerHTML = `<span class="badge ${badgeClass}">${displayText}</span>`;
            } else {
                statusCell.innerHTML = `<span class="badge bg-light text-dark">-</span>`;
            }
            
            // 标签列
            const labelsCell = document.createElement('td');
            labelsCell.className = 'labels';
            labelsCell.innerHTML = createLabelHTML(prData.current_labels);
            
            // 操作列
            const actionCell = document.createElement('td');
            actionCell.className = 'pr-actions';
            actionCell.innerHTML = `<button class="btn btn-danger btn-sm delete-pr-btn" 
                    data-owner="${prData.owner}" 
                    data-repo="${prData.repo}" 
                    data-pr-id="${prData.pr_id}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                    </svg>
                </button>`;
            
            row.appendChild(repoCell);
            row.appendChild(prIdCell);
            row.appendChild(titleCell);
            row.appendChild(authorCell);
            row.appendChild(branchCell);
            row.appendChild(statusCell);
            row.appendChild(labelsCell);
            row.appendChild(actionCell);
            tbody.appendChild(row);
        }

        // 处理添加PR表单
        document.getElementById('add-pr-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const prUrl = document.getElementById('pr_url').value.trim();
            if (!prUrl) {
                showMessage('请输入有效的 PR URL！', 'danger');
                return;
            }
            
            try {
                const response = await fetch('/api/add_pr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ pr_url: prUrl })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    document.getElementById('pr_url').value = '';
                    // 动态添加新行到表格
                    addPRToTable(result.pr_data);
                } else {
                    showMessage(result.error, 'danger');
                }
            } catch (error) {
                showMessage('添加PR时发生错误：' + error.message, 'danger');
            }
        });

        // 处理删除PR按钮
        document.addEventListener('click', async function(e) {
            // 查找最近的删除按钮元素（处理点击SVG图标或路径的情况）
            const deleteBtn = e.target.closest('.delete-pr-btn');
            if (deleteBtn) {
                e.preventDefault();
                
                const owner = deleteBtn.dataset.owner;
                const repo = deleteBtn.dataset.repo;
                const prId = deleteBtn.dataset.prId;
                
                if (!confirm(`确定要删除 ${owner}/${repo} 的 PR #${prId} 吗？`)) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/delete_pr', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            owner: owner, 
                            repo: repo, 
                            pr_id: prId 
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showMessage(result.message, 'success');
                        // 从DOM中移除该行
                        const row = deleteBtn.closest('tr');
                        if (row) {
                            row.remove();
                        }
                    } else {
                        showMessage(result.error, 'danger');
                    }
                } catch (error) {
                    showMessage('删除PR时发生错误：' + error.message, 'danger');
                }
            }
        });

        // 更新监控中的PR标签
        function updatePRLabels() {
            fetch('/api/pr_labels')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.querySelector('#pr-table-body');
                    tableBody.innerHTML = '';
                    for (const cacheKey in data) {
                        const prInfo = data[cacheKey];
                        const row = document.createElement('tr');
                        row.setAttribute('data-owner', prInfo.owner);
                        row.setAttribute('data-repo', prInfo.repo);
                        row.setAttribute('data-pr-id', prInfo.pr_id);
                        
                        // 仓库列
                        const repoCell = document.createElement('td');
                        if (prInfo.pr_details && prInfo.pr_details.base && prInfo.pr_details.base.repo && prInfo.pr_details.base.repo.html_url) {
                            repoCell.innerHTML = `<a href="${prInfo.pr_details.base.repo.html_url}" target="_blank">${prInfo.owner}/${prInfo.repo}</a>`;
                        } else {
                            repoCell.textContent = `${prInfo.owner}/${prInfo.repo}`;
                        }
                        
                        // PR编号列
                        const prIdCell = document.createElement('td');
                        if (prInfo.pr_details && prInfo.pr_details.html_url) {
                            prIdCell.innerHTML = `<a href="${prInfo.pr_details.html_url}" target="_blank">#${prInfo.pr_id}</a>`;
                        } else {
                            prIdCell.textContent = `#${prInfo.pr_id}`;
                        }
                        
                        // PR名称列
                        const titleCell = document.createElement('td');
                        if (prInfo.pr_details && prInfo.pr_details.title) {
                            if (prInfo.pr_details.html_url) {
                                titleCell.innerHTML = `<a href="${prInfo.pr_details.html_url}" target="_blank" title="${prInfo.pr_details.title}">${prInfo.pr_details.title}</a>`;
                            } else {
                                titleCell.textContent = prInfo.pr_details.title;
                            }
                        } else {
                            titleCell.textContent = '-';
                        }
                        
                        // 提交人列
                        const authorCell = document.createElement('td');
                        if (prInfo.pr_details && prInfo.pr_details.user) {
                            const userName = prInfo.pr_details.user.name || prInfo.pr_details.user.login;
                            if (prInfo.pr_details.user.html_url) {
                                authorCell.innerHTML = `<a href="${prInfo.pr_details.user.html_url}" target="_blank">${userName}</a>`;
                            } else {
                                authorCell.textContent = userName;
                            }
                        } else {
                            authorCell.textContent = '-';
                        }
                        
                        // 分支列
                        const branchCell = document.createElement('td');
                        if (prInfo.pr_details && prInfo.pr_details.base && prInfo.pr_details.base.ref) {
                            const branchName = prInfo.pr_details.base.ref;
                            if (prInfo.pr_details.base.repo && prInfo.pr_details.base.repo.html_url) {
                                branchCell.innerHTML = `<a href="${prInfo.pr_details.base.repo.html_url}/tree/${branchName}" target="_blank">${branchName}</a>`;
                            } else {
                                branchCell.textContent = branchName;
                            }
                        } else {
                            branchCell.textContent = '-';
                        }
                        
                        // 状态列
                        const statusCell = document.createElement('td');
                        if (prInfo.pr_details && prInfo.pr_details.state) {
                            const state = prInfo.pr_details.state;
                            let badgeClass = 'bg-warning';
                            let displayText = state.charAt(0).toUpperCase() + state.slice(1);
                            
                            if (state === 'open') {
                                badgeClass = 'bg-success';
                                displayText = 'Open';
                            } else if (state === 'closed') {
                                badgeClass = 'bg-danger';
                                displayText = 'Closed';
                            } else if (state === 'merged') {
                                badgeClass = 'bg-secondary';
                                displayText = 'Merged';
                            }
                            
                            statusCell.innerHTML = `<span class="badge ${badgeClass}">${displayText}</span>`;
                        } else {
                            statusCell.innerHTML = `<span class="badge bg-light text-dark">-</span>`;
                        }
                        
                        // 标签列
                        const labelsCell = document.createElement('td');
                        labelsCell.className = 'labels';
                        labelsCell.innerHTML = createLabelHTML(prInfo.current_labels);
                        
                        // 操作列
                        const actionCell = document.createElement('td');
                        actionCell.className = 'pr-actions';
                        actionCell.innerHTML = `<button class="btn btn-danger btn-sm delete-pr-btn" 
                                data-owner="${prInfo.owner}" 
                                data-repo="${prInfo.repo}" 
                                data-pr-id="${prInfo.pr_id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                </svg>
                            </button>`;
                        
                        row.appendChild(repoCell);
                        row.appendChild(prIdCell);
                        row.appendChild(titleCell);
                        row.appendChild(authorCell);
                        row.appendChild(branchCell);
                        row.appendChild(statusCell);
                        row.appendChild(labelsCell);
                        row.appendChild(actionCell);
                        tableBody.appendChild(row);
                    }
                    // 应用标签颜色
                    applyLabelColors();
                })
                .catch(error => console.error('Error fetching PR labels:', error));
        }
        
        // 刷新所有数据按钮事件处理
        document.getElementById('refresh-all').addEventListener('click', function() {
            updatePRLabels();
            showMessage('正在刷新所有数据...', 'info');
        });
        
        // 定时刷新
        setInterval(updatePRLabels, 60000); // 每分钟刷新监控PR
        
        // 初始加载
        updatePRLabels();
        
        // 页面加载完成后应用标签颜色
        document.addEventListener('DOMContentLoaded', function() {
            applyLabelColors();
        });
    </script>
</body>

</html>